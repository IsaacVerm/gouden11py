---
title: "Optimal selection players Gouden 11"
output: html_notebook
editor_options: 
  chunk_output_type: inline
---

# Goal

Goals i to find an optimal selection of players for Gouden 11. We'll start with a strategy of randomly picking players and then try to improve on that strategy by having a look at the most valuable players and see if they have any characteristics we can exploit. E.g. maybe all the most valuable players are in top teams, that would drastically reduce the number of options to choose from and make a selection strategy choosing players at random from top teams possible.

We'll also compare our selections to the selections chosen by real users.

```{r setup}
# clean environment
rm(list = ls())

# packages
library(ggplot2)
library(dplyr)
library(purrr)
library(ggpubr)

# load data
players <- read.csv(file = "players.csv", as.is = (c("name")))
formations_used <- read.csv(file = "formations_used_top_100_users.csv", header = FALSE)
```


```{r wrangling }
players <- players %>% 
  mutate(roi = points/value) # calculate roi
```

# All restrictions

## How to score points

Players score points for goals scored, clean sheets, ... Read the [rules](https://gouden11.hln.be/gouden-g11/rules) if you want the details. 

## The restrictions

* select 15 players (11 starting squad, 4 replacements)
* each game you can swap players between the starting squad and replacements
* max total value of 250M
* max 2 players of the same team
* use one of the predefined formations
* one of the starting players is a captain scoring 1.5 times the number of points
* 6 total transfers can be made over the entire season

## Some restrictions are more complicated to handle than others

Of these restrictions the following are variable:

* choice of captain
* transfers
* making replacements

Since complications arise out of those variable restrictions we won't focus on them in a preliminary analysis.

# Restrictions to focus on

The restrictions make clear there are 3 main factors for us to take into account:

* value (max of 250M)
* position (max of x players in position y depending on formation)
* club (max 2 players of the same team)

## Possible formations

The problem with the formations is they are not explicitly defined in the rules. The best way to find out what formations are possible is to have a look at the formations used by existing users.

```{r frequency_graph_used_formations }
ggplot(data = formations_used, aes(x = V1)) + geom_bar()
```

As the graph shows there are 6 possible formations:

* 3-4-3
* 3-5-2
* 4-3-3
* 4-4-2
* 4-5-1
* 5-3-2

3-4-3 is clearly the most popular one with about half of the top 100 users using that formation. This might be a strong indication this is also the best formation.

## Find the optimum

Regarding solutions, this looks like a lineair programming problem but let's first try to handle this manually. We just select teams randomly and filter out those teams meeting our restrictions.


# Random selection of players

Since the previous part showed the most used formation is 3-4-3 we'll select 1 keeper, 3 defenders, 4 midfielders and 3 attackers. We don't care about replacements so we just select 11 players. Let's select 1000 teams.

```{r randomly_select_teams }
nr_defenders <- 3
nr_midfielders <- 4
nr_attackers <- 3
nr_teams <- 6000

randomly_select_players <- function(nr_defenders, nr_midfielders, nr_attackers) {
  # randomly select players
  keeper <- players %>% filter(position_id == 1) %>% sample_n(1) # always select a keeper
  defenders <- players %>% filter(position_id == 2) %>% sample_n(nr_defenders)
  midfielders <- players %>% filter(position_id == 3) %>% sample_n(nr_midfielders)
  attackers <- players %>% filter(position_id == 4) %>% sample_n(nr_attackers)
  
  # bind together
  return(bind_rows(keeper, defenders, midfielders, attackers))
} 

random_teams <- replicate(nr_teams,
                          randomly_select_players(nr_defenders,
                                                  nr_midfielders,
                                                  nr_attackers),
                          simplify = FALSE)
```

Now we can check if each randomly selected team:

* has a value less or equal than 250M
* doesn't have more than 2 players of the same team

```{r check_restrictions}
assert_value_team_ok <- function(team) {
  sum(team$value) <= 250
}

assert_max_players_by_club_ok <- function(team) {
  all(table(team$club_id) <= 2)
}

filter_out_violating_team <- function(team) {
  if (assert_value_team_ok(team) & assert_max_players_by_club_ok(team)) {
    return(team)
  }
}

correct_teams <- random_teams %>% map(filter_out_violating_team) %>% discard(is.null) # NULL is violating team
```


# Compare points random teams with teams by real users

Let's see how well these random teams did compared to the teams selected by real users.

Points random teams:

```{r points_random_teams}
calculate_total_points <- function(team) {
  sum(team$points)
}

total_points_random_teams <- random_teams %>%
  map_int(calculate_total_points) %>%
  as.data.frame(.) %>% 
  setNames(c("total_points")) 

ggplot(data = total_points_random_teams,
       aes(x = total_points)) +
  geom_histogram()
```

Points teams selected by real users:

# Most valuable players

Only top 20 players within each position.

```{r}
top_20_players <- players %>%
  group_by(position_id) %>% # group id has to be calculated by position
  arrange(desc(roi)) %>% 
  top_n(20, roi) %>% # only interested in top 20 players by position
  mutate(group_id = 1:n()) # add unique id within each group of positions

ggplot(data = top_20_players,
       aes(x = group_id,
           y = roi,
           fill = club_name)) +
  geom_col() +
  ggpubr::rremove("x.text") +
  ggpubr::rremove("x.title") +
  facet_grid(. ~ position_id)
  
```

